<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>DulceFinder</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>

  <body>
    <div class="container">
      <header>
        <img
          src="{{ url_for('static', filename='img/logo.png') }}"
          alt="Logo"
          class="logo"
        />
        <img
          src="{{ url_for('static', filename='img/title.png') }}"
          alt="Dulce Finder"
          class="title"
        />
      </header>
      <form id="search-form" class="search-form">
        <input
          type="text"
          name="consulta"
          id="consulta"
          placeholder="¿Qué estás buscando?"
          required
        />
        <div class="language">
          <select name="idioma" class="language-select">
            <option value="es">Español</option>
            <option value="en" selected>English</option>
            <option value="pt">Português</option>
            <option value="de">Deutsch</option>
            <option value="fr">Français</option>
          </select>
        </div>
        <button type="submit">
          <img
            src="{{ url_for('static', filename='icon/search.svg') }}"
            alt="Buscar"
          />
        </button>
      </form>
      <div id="result-modal" class="modal hidden">
        <div class="modal-content">
          <div id="resultados"></div>
        </div>
      </div>
    </div>

    <script>
      document
        .getElementById("search-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const consulta = document.getElementById("consulta").value;
          const idioma = document.querySelector(".language-select").value;

          // Realizar la petición al backend
          try {
            const response = await fetch("/buscar", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({ consulta, idioma }),
            });
            const data = await response.json();
            renderResults(data);
          } catch (error) {
            console.error("Error en la búsqueda:", error);
          }
        });

      const categorias = {
        clases: "Clases",
        propiedades_clase: "Propiedades de la clase",
        subclases: "Subclases",
        instancias_clase: "Instancias de la clase",
        superclases: "Superclases de subclases",
        propiedades_subclase: "Propiedades de la subclase",
        individuos: "Instancias",
        clase_de_instancia: "Clase de la instancia",
        propiedades_instancia: "Propiedades de la instancia",
        usado_en_instancias: "Usado en otras instancias",
        valores: "Valores",
      };

      function renderResults(data) {
        const contenedor = document.getElementById("resultados");
        contenedor.innerHTML = "";
        const fragment = document.createDocumentFragment();
        let hayResultados = false;

        // Renderizar Ontología
        Object.entries(categorias).forEach(([tipo, nombre]) => {
          const valor = data[tipo];
          if (
            valor &&
            (Array.isArray(valor)
              ? valor.length > 0
              : Object.keys(valor).length > 0)
          ) {
            hayResultados = true;
            fragment.appendChild(createSection(nombre, valor));
          }
        });

        // Renderizar DBpedia
        if (data.descripcion_dbpedia) {
          const dbpediaData = data.descripcion_dbpedia;
          if (Array.isArray(dbpediaData) && dbpediaData.length > 0) {
            fragment.appendChild(createSection("DBpedia", dbpediaData));
            hayResultados = true;
          } else if (typeof dbpediaData === "string" && dbpediaData !== "") {
            const section = document.createElement("div");
            const titulo = document.createElement("h3");
            titulo.textContent = "DBpedia";
            section.appendChild(titulo);
            const p = document.createElement("p");
            p.textContent = dbpediaData;
            section.appendChild(p);
            fragment.appendChild(section);
            hayResultados = true;
          }
        }
        if (!hayResultados) {
          const mensaje = document.createElement("p");
          mensaje.textContent = "No se encontraron resultados.";
          fragment.appendChild(mensaje);
        }
        contenedor.appendChild(fragment);
        mostrarModal();
      }
      // Función para crear secciones
      function createSection(title, items) {
        const section = document.createElement("div");
        const titulo = document.createElement("h3");
        titulo.textContent = title;
        section.appendChild(titulo);
        const ul = document.createElement("ul");

        if (Array.isArray(items)) {
          items.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
        } else if (typeof items === "object") {
          for (const key in items) {
            const li = document.createElement("li");
            const propiedad = items[key];
            if (Array.isArray(propiedad)) {
              li.textContent = `${key}: ${propiedad.join(", ")}`;
            } else if (typeof propiedad === "object" && propiedad !== null) {
              li.textContent = `${key}:`;
              const innerUl = document.createElement("ul");
              Object.entries(propiedad).forEach(([innerKey, value]) => {
                const innerLi = document.createElement("li");
                innerLi.textContent = `${innerKey}: ${
                  Array.isArray(value) ? value.join(", ") : value
                }`;
                innerUl.appendChild(innerLi);
              });
              li.appendChild(innerUl);
            } else {
              li.textContent = `${key}: ${propiedad}`;
            }
            ul.appendChild(li);
          }
        }
        section.appendChild(ul);
        return section;
      }
      function mostrarModal() {
        document.getElementById("result-modal").classList.add("show");
      }
    </script>
  </body>
</html>
